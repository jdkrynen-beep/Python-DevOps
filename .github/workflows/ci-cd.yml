name: CI/CD Pipeline

on:
  push:
    branches: [main, dev]

permissions:
  contents: write
  pull-requests: write

jobs:
  
  # JOB 1 : Tests & Qualité

  tests:
    name: Tests & Qualité
    runs-on: ubuntu-latest
    steps:
      
      - name: Checkout code
        uses: actions/checkout@v4

      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      
      - name: Install dependencies
        run: |
          pip install -r requirements.txt

      
      - name: Run Flake8
        run: | 
          flake8 app/ --count --max-line-length=100 --statistics --exclude=__pycache__
    
      - name: Run PyTest
        run: |
          pytest tests/ -v

  # JOB 2 : Build & Securité
  build:
    name: Build & Securité
    runs-on: ubuntu-latest
    needs: tests

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Build Docker Image
        run: |
          docker build -t inventory-api:test .
      
      - name: Check image size
        run: |
          echo " Vérification de la taille de l'image Docker"
          docker images inventory-api:test --format "{{.Repository}}:{{.Tag}} -> {{.Size}}"

          SIZE=$(docker images inventory-api:test --format "{{.Size}}")
          echo "Taille actuelle : $SIZE"
          echo "Limite maximale: 100 MB"
          echo " Vérifiez manuellement que la taille est < 100MB"

      - name: Test API in container
        run: |
          echo "Lancement des tests du container"
          docker run -d --name test-api -p 5000:5000 inventory-api:test
          echo "Attente du démarrage de l'API (10 secondes)"
          sleep 10

          echo "Test endpoint /health"
          curl -f "http://localhost:5000/api/v1/health" || exit 1

          echo "Test endpoint /servers"
          curl -f "http://localhost:5000/api/v1/servers" || exit 1

          echo "Test endpoint /servers/1"
          curl -f "http://localhost:5000/api/v1/servers/1" || exit 1

          echo "Tous les tests du container ont réussi"
          docker stop test-api
          docker rm test-api

      - name: Run Trivy security scan
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'inventory-api:test'
          format: 'table'
          exit-code: '0'
          severity: 'CRITICAL,HIGH'

  # JOB 3 : PR automatique dev → main
  create-pr:
    name: PR Automatique
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/dev'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create PR dev to main
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr create --base main --head dev --title "[AUTO] Merge dev into main" --body "PR automatique - Tests OK, Flake8 OK, Docker OK, Trivy OK" || echo "PR already exists"
  # JOB 4 : Deploiement Production
  deploy-production:
    name: Deploiement Production
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download Docker image artifact
        uses: actions/download-artifact@v4
        with:
          name: docker-image

      - name: Load Docker image
        run: |
          docker load -i inventory-api-image.tar
          docker tag ${{ env.IMAGE_NAME }}:test ${{ env.IMAGE_NAME }}:latest

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Tag and Push Docker images
        run: |
          docker tag ${{ env.IMAGE_NAME }}:latest ${{ env.REGISTRY }}/${{ github.repository_owner }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
          docker tag ${{ env.IMAGE_NAME }}:latest ${{ env.REGISTRY }}/${{ github.repository_owner }}/${{ env.IMAGE_NAME }}:latest
          
          DATE_TAG=$(date +%Y%m%d-%H%M%S)
          docker tag ${{ env.IMAGE_NAME }}:latest ${{ env.REGISTRY }}/${{ github.repository_owner }}/${{ env.IMAGE_NAME }}:$DATE_TAG
          
          echo "Pushing images to registry..."
          docker push ${{ env.REGISTRY }}/${{ github.repository_owner }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
          docker push ${{ env.REGISTRY }}/${{ github.repository_owner }}/${{ env.IMAGE_NAME }}:latest
          docker push ${{ env.REGISTRY }}/${{ github.repository_owner }}/${{ env.IMAGE_NAME }}:$DATE_TAG
          
          echo "Images pushed successfully"

      - name: Create deployment summary
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          ## Deploiement Production Reussi
          
          ### Images Docker publiees
          
          | Tag | Registry URL |
          |-----|--------------|
          | latest | ${{ env.REGISTRY }}/${{ github.repository_owner }}/${{ env.IMAGE_NAME }}:latest |
          | ${{ github.sha }} | ${{ env.REGISTRY }}/${{ github.repository_owner }}/${{ env.IMAGE_NAME }}:${{ github.sha }} |
          
          ### Informations
          
          - Commit: ${{ github.sha }}
          - Auteur: ${{ github.actor }}
          - Branch: main
          - Date: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          
          ### Verifications
          
          - Tests PyTest passes
          - Qualite Flake8 validee
          - Image Docker < 100 MB
          - Tests API reussis
          - Scan Trivy effectue
          
          EOF

      - name: Deployment notification
        uses: actions/github-script@v7
        with:
          script: |
            const message = `## Deploiement en Production Reussi
            
            **Image Docker:** \`${{ env.REGISTRY }}/${{ github.repository_owner }}/${{ env.IMAGE_NAME }}:latest\`
            
            **Details:**
            - Commit: \`${{ github.sha }}\`
            - Workflow: [#${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            - Auteur: @${{ github.actor }}
            
            **Pull image:**
            \`\`\`bash
            docker pull ${{ env.REGISTRY }}/${{ github.repository_owner }}/${{ env.IMAGE_NAME }}:latest
            docker run -p 5000:5000 ${{ env.REGISTRY }}/${{ github.repository_owner }}/${{ env.IMAGE_NAME }}:latest
            \`\`\`
            
            Application deployee avec succes`;
            
            github.rest.repos.createCommitComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              commit_sha: context.sha,
              body: message
            });

      - name: Send deployment status
        run: |
          echo "Deploiement termine avec succes"
          echo "Image disponible: ${{ env.REGISTRY }}/${{ github.repository_owner }}/${{ env.IMAGE_NAME }}:latest"
          echo "SHA: ${{ github.sha }}"